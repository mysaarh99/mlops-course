name: MLOps CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-train-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) سحب الكود
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      # 2) إعداد Python
      - name: 🐍 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 3) Cache pip
      - name: 📦 Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4) تثبيت المتطلبات
      - name: 📚 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc-ssh

      # 5) تحميل مفاتيح SSH (DVC + السيرفر) دفعة واحدة
      - name: 🔑 Load SSH keys (DVC + Deploy)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.SERVER_SSH_KEY }}

      # 6) إضافة السيرفر إلى known_hosts
      - name: 🧩 Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # 7) اختبار اتصال SSH (بعد تحميل المفاتيح)
      - name: 🧪 Test SSH connection
        run: ssh -o StrictHostKeyChecking=yes ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo ok"

      # 8) تنظيف أي keyfile محفوظ داخل dvc config (لتفادي مسارات ويندوز)
      - name: 🧼 Unset DVC keyfile if present
        run: dvc config --unset "remote.origin.keyfile" || true

      # 9) تسجيل الدخول إلى W&B
      - name: 🔑 Login to Weights & Biases
        run: wandb login ${{ secrets.WANDB_API_KEY }}

      # 10) سحب البيانات من DVC
      - name: 📥 DVC pull data
        run: dvc pull

      # 11) إعادة إنتاج البايبلاين
      - name: ⚙️ Reproduce pipeline with DVC
        run: dvc repro

      # 12) تسجيل الدخول إلى Docker Hub
      - name: 🔑 Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      # 13) إعداد Buildx
      - name: 🛠️ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 14) إنشاء tag زمني
      - name: 🏷️ Generate Docker image tag
        id: tagger
        run: echo "tag=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_OUTPUT

      # 15) بناء ورفع الصورة مع كاش GHA
      - name: 🐳 Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/mlops-api:latest
            ${{ secrets.DOCKER_HUB_USERNAME }}/mlops-api:${{ steps.tagger.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 16) التحقق من وجود مفتاح النشر (للتشخيص)
      - name: ✅ Check deploy key presence
        run: |
          if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
            echo "❌ SERVER_SSH_KEY is empty or unavailable"; exit 1
          fi
          echo "✅ SERVER_SSH_KEY is set."

      # 17) نشر التطبيق + Health Check
      - name: 🚀 Deploy via SSH (install docker if missing + run + health check)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          ssh -tt \
            -o StrictHostKeyChecking=yes \
            -o TCPKeepAlive=yes \
            -o ServerAliveInterval=15 \
            -o ServerAliveCountMax=6 \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}" <<'EOF'
          set -e

          IMAGE="${{ secrets.DOCKER_HUB_USERNAME }}/mlops-api:latest"

          # 0) تحديث الحزم الأساسية
          if ! command -v curl >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y curl
          fi

          # 1) تثبيت Docker إن لم يكن موجودًا
          if ! command -v docker >/dev/null 2>&1; then
            echo "🧩 Installing Docker..."
            # أبسط خيار ثابت على Ubuntu
            sudo apt-get update -y
            sudo apt-get install -y docker.io
            # تأكد من عمل الخدمة
            sudo systemctl enable --now docker
            # نستخدم sudo لاحقًا بدل إضافة المستخدم لمجموعة docker (لأنها تحتاج تسجيل خروج/دخول)
          fi

          # 2) تسجيل دخول Docker Hub (لا تفشل الـ pipeline لو فشل اللوجين)
          echo "${{ secrets.DOCKER_HUB_TOKEN }}" | sudo docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin || true

          # 3) سحب الصورة وتشغيل الحاوية
          sudo docker pull -q "$IMAGE"

          # أوقف/احذف النسخة القديمة إن وجدت
          sudo docker stop mlops-api || true
          sudo docker rm mlops-api || true

          # 4) تشغيل الخدمة
          # ملاحظة: المنفذ 80 يتطلب صلاحيات root؛ نحن نستخدم sudo docker لذلك لا مشكلة.
          # إن كان عندك Nginx/Apache على 80 سيحدث تعارض—غيّر المنفذ مثلاً إلى 8080:8000 ثم عدّل فحص الصحة.
          sudo docker run -d --name mlops-api \
            -p 80:8000 \
            --restart=always \
            -e WANDB_API_KEY="${{ secrets.WANDB_API_KEY }}" \
            "$IMAGE"

          # 5) فحص الصحة
          echo "⏳ Waiting for API to start..."
          for i in {1..10}; do
            if curl -sSf http://localhost:80/docs >/dev/null; then
              echo "✅ API is up and running"
              exit 0
            fi
            echo "Retrying in 3s..."
            sleep 3
          done

          echo "❌ API did not start in expected time"
          sudo docker logs --tail=200 mlops-api || true
          exit 1
          EOF


      #  ملخص التنفيذ
      - name: 📜 Summary
        if: always()
        run: |
          echo "## ✅ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Docker images pushed:" >> $GITHUB_STEP_SUMMARY
          echo "  * latest" >> $GITHUB_STEP_SUMMARY
          echo "  * ${{ steps.tagger.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
