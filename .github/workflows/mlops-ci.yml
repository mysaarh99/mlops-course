name: MLOps CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-train-deploy:
    runs-on: ubuntu-latest

    # â¬‡ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (DVC) ÙˆØ§Ù„Ù†Ø´Ø±
    env:
      WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
      WANDB_PROJECT: mlops-monitoring
      # WANDB_ENTITY: your-entity-if-used   # Ø§ØªØ±ÙƒÙ‡ ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù Ø¥Ù† Ù„Ù… ØªØ³ØªØ®Ø¯Ù… Teams

    steps:
      # 1) Ø³Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

        

      # 2) Ø¥Ø¹Ø¯Ø§Ø¯ Python
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3) Cache pip
      - name: ğŸ“¦ Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4) ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
      - name: ğŸ“š Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc-ssh

      - name: ğŸ”‘ Start ssh-agent and add key
        if: github.event_name == 'push'
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.DVC_SSH_KEY }}
            ${{ secrets.SERVER_SSH_KEY }}

      - name: Add server to known_hosts
        if: github.event_name == 'push'
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          # Ù„Ùˆ Ù…Ù†ÙØ° ØºÙŠØ± 22:
          # ssh-keyscan -p ${{ secrets.SERVER_SSH_PORT }} -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ§ª Test SSH (verbose)
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}   # root Ø£Ùˆ dvc (ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ·Ø§Ø¨Ù‚ ØµØ§Ø­Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±)
          SERVER_HOST: ${{ secrets.SERVER_HOST }}   # 188.227.87.3
          SERVER_SSH_PORT: ${{ secrets.SERVER_SSH_PORT }}   # Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ 22 Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
        run: |
          ssh -o StrictHostKeyChecking=yes -vvv ${SERVER_USER}@${SERVER_HOST} ${SERVER_SSH_PORT:+-p ${SERVER_SSH_PORT}} "echo ok"

      - name: DVC push (example)
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_SSH_PORT: ${{ secrets.SERVER_SSH_PORT }}
        run: |
          # Ø§Ø¬Ø¹Ù„ DVC ÙŠØ³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ù…Ø¶ÙŠÙ ÙˆØ§Ù„Ù…ÙØªØ§Ø­ Ø¹Ø¨Ø± URL SSH
          dvc remote modify origin url ssh://${SERVER_USER}@${SERVER_HOST}${SERVER_SSH_PORT:+:${SERVER_SSH_PORT}}/dvc-storage/files
          dvc push -v

      # 8) ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ keyfile Ù…Ø­ÙÙˆØ¸ Ø¯Ø§Ø®Ù„ dvc config (Ù„ØªÙØ§Ø¯ÙŠ Ù…Ø³Ø§Ø±Ø§Øª ÙˆÙŠÙ†Ø¯ÙˆØ²) â€” Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹ ÙÙ‚Ø·
      - name: ğŸ§¼ Unset DVC keyfile if present
        if: github.event_name == 'push'
        run: dvc config --unset "remote.origin.keyfile" || true

      # (ØªÙ… Ø­Ø°Ù Ø®Ø·ÙˆØ© wandb loginØ› Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ env: WANDB_API_KEY)
      # 9) â† Ù…Ø­Ø°ÙˆÙØ©

      # 10) Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† DVC â€” Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹ ÙÙ‚Ø·
      - name: ğŸ“¥ DVC pull data
        if: github.event_name == 'push'
        run: dvc pull

      # 11) Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ø¨Ø§ÙŠØ¨Ù„Ø§ÙŠÙ† â€” Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹ ÙÙ‚Ø·
      - name: âš™ï¸ Reproduce pipeline with DVC
        if: github.event_name == 'push'
        run: dvc repro

      # 12) Ø¯ÙØ¹ Ø¨ÙŠØ§Ù†Ø§Øª/Ù†Ù…Ø§Ø°Ø¬ DVC Ø¥Ù„Ù‰ Ø§Ù„Ø±ÙŠÙ…ÙˆØª â€” Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹ ÙÙ‚Ø·
      - name: ğŸ“¤ DVC push data
        if: github.event_name == 'push'
        run: dvc push

      # 13) ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Docker Hub â€” Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹ ÙÙ‚Ø·
      - name: ğŸ”‘ Log in to Docker Hub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      # 14) Ø¥Ø¹Ø¯Ø§Ø¯ Buildx
      - name: ğŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 15) Ø¥Ù†Ø´Ø§Ø¡ tag Ø²Ù…Ù†ÙŠ
      - name: ğŸ·ï¸ Generate Docker image tag
        id: tagger
        run: echo "tag=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_OUTPUT

      # 16) Ø¨Ù†Ø§Ø¡ ÙˆØ±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© â€” Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹ ÙÙ‚Ø·
      - name: ğŸ³ Build and Push Docker Image
        if: github.event_name == 'push'
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/mlops-api:latest
            ${{ secrets.DOCKER_HUB_USERNAME }}/mlops-api:${{ steps.tagger.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 17) Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ÙØªØ§Ø­ Ø§Ù„Ù†Ø´Ø± â€” Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹ ÙÙ‚Ø·
      - name: âœ… Check deploy key presence
        if: github.event_name == 'push'
        run: |
          if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
            echo "âŒ SERVER_SSH_KEY is empty or unavailable"; exit 1
          fi
          echo "âœ… SERVER_SSH_KEY is set."

      # 18) Ù†Ø´Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ + Health Check â€” Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹ ÙÙ‚Ø·
      - name: ğŸš€ Deploy via SSH (docker run + health check)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          ssh -tt \
            -o StrictHostKeyChecking=yes \
            -o TCPKeepAlive=yes \
            -o ServerAliveInterval=15 \
            -o ServerAliveCountMax=6 \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} <<'EOF'
          set -e

          IMAGE="${{ secrets.DOCKER_HUB_USERNAME }}/mlops-api:latest"

          # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ø°Ø§ Ø§Ù„ØµÙˆØ±Ø© Ø®Ø§ØµØ© (ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ÙØ´Ù„ Ø¥Ù† ÙƒØ§Ù†Øª Ø¹Ø§Ù…Ø©)
          echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin || true

          docker pull -q "$IMAGE"

          docker stop mlops-api || true
          docker rm mlops-api || true

          # ØªÙ…Ø±ÙŠØ± Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ API ÙˆW&B
          docker run -d --name mlops-api \
            -p 80:8000 \
            --restart=always \
            -e WANDB_API_KEY='${{ secrets.WANDB_API_KEY }}' \
            -e WANDB_PROJECT='mlops-monitoring' \
            -e TEXT_MODEL_NAME='baseline' \
            -e IMG_MODEL_NAME='baseline' \
            "$IMAGE"

          echo "â³ Waiting for API to start..."
          for i in {1..10}; do
            if curl -sSf http://localhost:80/health > /dev/null; then
              echo "âœ… API is up and running"
              exit 0
            fi
            echo "Retrying in 3s..."
            sleep 3
          done

          echo "âŒ API did not start in expected time"
          docker logs --tail=200 mlops-api || true
          exit 1
          EOF

      # 19) Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ†ÙÙŠØ°
      - name: ğŸ“œ Summary
        if: always()
        run: |
          echo "## âœ… Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Docker image tag:" >> $GITHUB_STEP_SUMMARY
          echo "  * latest" >> $GITHUB_STEP_SUMMARY
          echo "  * ${{ steps.tagger.outputs.tag }}" >> $GITHUB_STEP_SUMMARY

