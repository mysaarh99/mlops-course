name: MLOps CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-train-deploy:
    runs-on: ubuntu-latest

    steps:
      # =======================
      # 1ï¸âƒ£ Ø³Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯
      # =======================
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # =======================
      # 2ï¸âƒ£ Ø¥Ø¹Ø¯Ø§Ø¯ Python
      # =======================
      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # =======================
      # 3ï¸âƒ£ Cache pip
      # =======================
      - name: ðŸ“¦ Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # =======================
      # 4ï¸âƒ£ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
      # =======================
      - name: ðŸ“š Install dependencies
        run: |
          echo "=== Installing Python dependencies ==="
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc-ssh

      - name: ðŸ”‘ Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DVC_SSH_KEY }}
            
      - name: ðŸ§© Known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 31.44.0.199 >> ~/.ssh/known_hosts

      # =======================
      # 5ï¸âƒ£ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ W&B
      # =======================
      - name: ðŸ”‘ Login to Weights & Biases
        run: wandb login ${{ secrets.WANDB_API_KEY }}

      # =======================
      # 6ï¸âƒ£ ØªØ´ØºÙŠÙ„ Ø®Ø· DVC
      # =======================

      - name: ðŸ“¥ DVC pull data
        run: dvc pull

   
      - name: âš™ï¸ Reproduce pipeline with DVC
        run: |
          echo "=== Running DVC pipeline ==="
          dvc repro

      # =======================
      # 7ï¸âƒ£ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Docker Hub
      # =======================
      - name: ðŸ”‘ Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      # =======================
      # 8ï¸âƒ£ Ø¥Ø¹Ø¯Ø§Ø¯ Docker Buildx
      # =======================
      - name: ðŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # =======================
     
      # =======================
      # 9 Ø¥Ù†Ø´Ø§Ø¡ tag Ø²Ù…Ù†ÙŠ
      # =======================
      - name: ðŸ·ï¸ Generate Docker image tag
        id: tagger
        run: echo "tag=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_OUTPUT

      # =======================
      # 1ï¸âƒ£1ï¸âƒ£ Ø¨Ù†Ø§Ø¡ ÙˆØ±ÙØ¹ ØµÙˆØ±Ø© Docker
      # =======================
      - name: ðŸ³ Build and Push Docker Image with cache
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/mlops-api:latest
            ${{ secrets.DOCKER_HUB_USERNAME }}/mlops-api:${{ steps.tagger.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max


      # =======================
      # 1ï¸âƒ£2ï¸âƒ£ Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ†ÙÙŠØ°
      # =======================
      - name: ðŸ“œ Summary
        if: always()
        run: |
          echo "## âœ… Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Docker images pushed:" >> $GITHUB_STEP_SUMMARY
          echo "  * latest" >> $GITHUB_STEP_SUMMARY
          echo "  * ${{ steps.tagger.outputs.tag }}" >> $GITHUB_STEP_SUMMARY

