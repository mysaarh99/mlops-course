name: MLOps CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-train-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Ø³Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # 2) Ø¥Ø¹Ø¯Ø§Ø¯ Python
      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 3) Cache pip
      - name: ðŸ“¦ Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4) ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
      - name: ðŸ“š Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc-ssh

      # 5) ØªØ­Ù…ÙŠÙ„ Ù…ÙØ§ØªÙŠØ­ SSH (Ù„Ù„Ø³ÙŠØ±ÙØ±)
      - name: ðŸ”‘ Load SSH keys (Deploy)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.SERVER_SSH_KEY }}

      # 6) Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¥Ù„Ù‰ known_hosts
      - name: ðŸ§© Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # 7) Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ SSH
      - name: ðŸ§ª Test SSH connection
        run: ssh -o StrictHostKeyChecking=yes ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo ok"

      # 8) ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ keyfile Ù…Ø­ÙÙˆØ¸ Ø¯Ø§Ø®Ù„ dvc config (Ø¥Ù† ÙˆØ¬Ø¯)
      - name: ðŸ§¼ Unset DVC keyfile if present
        run: dvc config --unset "remote.origin.keyfile" || true

      # 9) ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ W&B (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ùˆ Ø¨ØªØ­ØªØ§Ø¬Ù‡ Ø¨Ø§Ù„Ù€ repro)
      - name: ðŸ”‘ Login to Weights & Biases
        run: wandb login ${{ secrets.WANDB_API_KEY }}

      # 10) Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† DVC
      - name: ðŸ“¥ DVC pull data
        run: dvc pull

      # 11) Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ø¨Ø§ÙŠØ¨Ù„Ø§ÙŠÙ†
      - name: âš™ï¸ Reproduce pipeline with DVC
        run: dvc repro

      # 12) ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Docker Hub
      - name: ðŸ”‘ Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      # 13) Ø¥Ø¹Ø¯Ø§Ø¯ Buildx
      - name: ðŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 14) Ø¥Ù†Ø´Ø§Ø¡ tag Ø²Ù…Ù†ÙŠ
      - name: ðŸ·ï¸ Generate Docker image tag
        id: tagger
        run: echo "tag=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_OUTPUT

      # 15) Ø¨Ù†Ø§Ø¡ ÙˆØ±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¹ ÙƒØ§Ø´ GHA
      - name: ðŸ³ Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/mlops-api:latest
            ${{ secrets.DOCKER_HUB_USERNAME }}/mlops-api:${{ steps.tagger.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 16) Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ÙØªØ§Ø­ Ø§Ù„Ù†Ø´Ø±
      - name: âœ… Check deploy key presence
        run: |
          if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
            echo "âŒ SERVER_SSH_KEY is empty or unavailable"; exit 1
          fi
          echo "âœ… SERVER_SSH_KEY is set."

      # 17) Ø§Ù„Ù†Ø´Ø± Ø¹Ø¨Ø± SSH 
      - name: ðŸš€ Deploy via SSH (clean version, no backslashes)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          ssh -o BatchMode=yes \
              -o StrictHostKeyChecking=yes \
              -o TCPKeepAlive=yes \
              -o ServerAliveInterval=15 \
              -o ServerAliveCountMax=6 \
              "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}" '
            set -euo pipefail;
            IMAGE="${{ secrets.DOCKER_HUB_USERNAME }}/mlops-api:latest";

            # 0) Install curl if missing
            if ! command -v curl >/dev/null 2>&1; then
              sudo apt-get update -y;
              sudo apt-get install -y curl;
            fi;

            # 1) Install Docker if missing
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get update -y;
              sudo apt-get install -y docker.io;
              sudo systemctl enable --now docker;
            fi;

            # 2) Docker login
            echo "${{ secrets.DOCKER_HUB_TOKEN }}" | sudo docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin || true;

            # 3) Pull image and run
            sudo docker pull "$IMAGE";
            sudo docker stop mlops-api || true;
            sudo docker rm mlops-api || true;
            sudo docker run -d --name mlops-api \
              -p 8080:8000 \
              --restart=always \
              -e WANDB_API_KEY="${{ secrets.WANDB_API_KEY }}" \
              "$IMAGE";

            # 4) Health check
            echo "â³ Waiting for API to start...";
            for i in {1..20}; do
              if curl --max-time 2 -sSf http://localhost:8080/docs >/dev/null; then
                echo "âœ… API is up and running on :8080";
                exit 0;
              fi;
              echo "Retrying in 3s...";
              sleep 3;
            done;

            echo "âŒ API did not start in expected time";
            sudo docker logs --tail=200 mlops-api || true;
            exit 1;
          '


      # 18) Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ†ÙÙŠØ°
      - name: ðŸ“œ Summary
        if: always()
        run: |
          echo "## âœ… Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Docker images pushed:" >> $GITHUB_STEP_SUMMARY
          echo "  * latest" >> $GITHUB_STEP_SUMMARY
          echo "  * ${{ steps.tagger.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
